<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mah Jongg Club â€” NLNA Community Center</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --red: #c0392b;
    --red-dark: #96281b;
    --red-pale: #fdf2f1;
    --charcoal: #2c2c2c;
    --mid: #555;
    --muted: #888;
    --border: #e0e0e0;
    --bg: #f7f7f7;
    --white: #ffffff;
    --green-pale: #eafaf1;
    --blue-pale: #eaf4fb;
    --blue-info: #2980b9;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--charcoal); min-height: 100vh; font-size: 14px; }

  .top-bar { background: var(--charcoal); color: rgba(255,255,255,0.65); font-size: 11px; letter-spacing: 0.04em; text-align: center; padding: 7px 20px; }
  .top-bar a { color: rgba(255,255,255,0.65); text-decoration: none; }
  .top-bar a:hover { color: #fff; }

  header { background: var(--white); border-bottom: 3px solid var(--red); padding: 0 40px; }
  .header-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; gap: 24px; padding: 18px 0; flex-wrap: wrap; }
  .nlna-logo-block { display: flex; flex-direction: column; line-height: 1.1; border-right: 2px solid var(--border); padding-right: 24px; }
  .nlna-org { font-size: 9px; font-weight: 700; letter-spacing: 0.18em; text-transform: uppercase; color: var(--muted); }
  .nlna-name { font-size: 15px; font-weight: 800; color: var(--charcoal); line-height: 1.25; }
  .nlna-name span { color: var(--red); }
  .header-text { flex: 1; }
  .header-title { font-family: 'Source Serif 4', serif; font-size: 1.55rem; font-weight: 600; color: var(--charcoal); }
  .header-sub { font-size: 11px; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; margin-top: 3px; }
  .session-chip { background: var(--red); color: #fff; font-size: 11px; font-weight: 700; padding: 7px 16px; border-radius: 3px; text-align: center; line-height: 1.5; white-space: nowrap; }
  .chip-label { font-weight: 500; opacity: 0.85; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; display: block; }

  .tab-bar { background: var(--white); border-bottom: 1px solid var(--border); }
  .tab-bar-inner { max-width: 1100px; margin: 0 auto; padding: 0 40px; display: flex; }
  .tab-btn { padding: 14px 22px; background: none; border: none; border-bottom: 3px solid transparent; margin-bottom: -1px; font-family: 'Montserrat', sans-serif; font-size: 12px; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; color: var(--muted); cursor: pointer; transition: all 0.15s; }
  .tab-btn:hover { color: var(--charcoal); }
  .tab-btn.active { color: var(--red); border-bottom-color: var(--red); }

  .main { max-width: 1100px; margin: 0 auto; padding: 32px 40px 60px; }
  .panel { display: none; }
  .panel.active { display: block; }

  .sec-hdr { display: flex; align-items: center; gap: 14px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid var(--border); flex-wrap: wrap; }
  .sec-title { font-family: 'Source Serif 4', serif; font-size: 1.35rem; font-weight: 600; color: var(--charcoal); }
  .sec-meta { font-size: 11px; color: var(--muted); }

  .status-box { background: var(--white); border: 1px solid var(--border); border-radius: 4px; padding: 48px 32px; text-align: center; color: var(--muted); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .status-box.error { border-left: 4px solid var(--red); color: #7b1c1c; text-align: left; padding: 24px 28px; }
  .spinner { display: inline-block; width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--red); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .status-box p { font-size: 13px; line-height: 1.7; margin-top: 6px; }

  .lb-wrap { background: var(--white); border: 1px solid var(--border); border-radius: 4px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  table { width: 100%; border-collapse: collapse; min-width: 620px; }
  thead th { background: var(--charcoal); color: rgba(255,255,255,0.75); font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 11px 14px; text-align: left; cursor: pointer; user-select: none; white-space: nowrap; }
  thead th:hover { background: #3a3a3a; color: #fff; }
  thead th.sorted { color: #fff; }
  thead th .arr { margin-left: 4px; opacity: 0.5; font-size: 10px; }
  thead th.sorted .arr { opacity: 1; }
  tbody tr { border-bottom: 1px solid var(--border); }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover td { background: #fafafa; }
  tbody td { padding: 11px 14px; vertical-align: middle; }

  .rank-num { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 50%; font-weight: 800; font-size: 12px; }
  .r1 { background: #f0c040; color: #6b4f00; }
  .r2 { background: #c8c8c8; color: #444; }
  .r3 { background: #cd8a5a; color: #fff; }
  .rn { background: var(--bg); color: var(--muted); font-weight: 600; border: 1px solid var(--border); }

  .pname { font-weight: 700; font-size: 13.5px; }
  .pts-big { font-weight: 800; font-size: 15px; }
  .pill { display: inline-block; padding: 2px 9px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .pill-w { background: var(--green-pale); color: #1a7a42; }
  .pill-l { background: #fef0f0; color: #a02020; }
  .pill-wg { background: #f3f3f3; color: #666; }

  .rate-wrap { display: flex; align-items: center; gap: 8px; min-width: 110px; }
  .rate-bar { flex: 1; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .rate-fill { height: 100%; background: var(--red); border-radius: 3px; }
  .rate-pct { font-size: 11px; color: var(--muted); min-width: 30px; }

  .xrow { display: none; }
  .xrow td { padding: 0; background: #fafafa; }
  .xinner { padding: 12px 48px; display: flex; gap: 28px; flex-wrap: wrap; border-top: 1px dashed var(--border); }
  .xstat { display: flex; flex-direction: column; gap: 2px; }
  .xstat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
  .xstat-val { font-weight: 700; font-size: 14px; color: var(--charcoal); }

  .hint { font-size: 11px; color: var(--muted); text-align: center; margin-top: 12px; }

  .btn-refresh { background: none; border: 1px solid var(--border); color: var(--mid); padding: 6px 14px; font-size: 11px; font-weight: 600; font-family: 'Montserrat', sans-serif; border-radius: 3px; cursor: pointer; transition: all 0.15s; letter-spacing: 0.04em; margin-left: auto; }
  .btn-refresh:hover { border-color: var(--red); color: var(--red); }

  .hist-card { background: var(--white); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .hist-controls { padding: 12px 20px; border-bottom: 1px solid var(--border); background: var(--bg); display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  .hist-controls label { font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--mid); }
  .hist-controls select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 3px; font-family: 'Montserrat', sans-serif; font-size: 12px; }
  .hist-list { list-style: none; }
  .hist-item { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; padding: 12px 20px; border-bottom: 1px solid var(--border); font-size: 12.5px; }
  .hist-item:last-child { border-bottom: none; }
  .hist-date { color: var(--muted); min-width: 88px; font-size: 11.5px; }
  .hist-winner { font-weight: 700; }
  .hist-pts { background: var(--red); color: #fff; font-size: 11px; font-weight: 700; padding: 2px 9px; border-radius: 12px; }
  .hist-others { color: var(--muted); font-size: 11.5px; flex: 1; }
  .hist-wall { font-style: italic; color: var(--muted); }
  .hist-note { font-style: italic; color: #aaa; font-size: 11px; }
  .no-data { padding: 36px; text-align: center; color: var(--muted); font-style: italic; }

  .guide-card { background: var(--white); border: 1px solid var(--border); border-radius: 4px; padding: 28px 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .guide-card h3 { font-family: 'Source Serif 4', serif; font-size: 1.05rem; font-weight: 600; color: var(--charcoal); margin: 22px 0 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
  .guide-card h3:first-of-type { margin-top: 0; }
  .guide-card p { line-height: 1.75; color: var(--mid); margin-bottom: 10px; font-size: 13px; }
  .callout { border-radius: 0 3px 3px 0; padding: 12px 16px; font-size: 12.5px; line-height: 1.7; margin: 10px 0; }
  .callout-blue { background: var(--blue-pale); border-left: 4px solid var(--blue-info); color: #1a5276; }
  .callout-red { background: var(--red-pale); border-left: 4px solid var(--red); color: #7b1c1c; }
  .callout-mono { font-family: monospace; font-size: 12px; letter-spacing: 0.02em; }
  .score-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(185px, 1fr)); gap: 10px; margin-bottom: 10px; }
  .score-box { border: 1px solid var(--border); border-left: 3px solid var(--red); border-radius: 3px; padding: 10px 12px; background: var(--bg); }
  .score-box.bonus { border-left-color: #e67e22; }
  .score-pts { font-weight: 800; font-size: 1.2rem; color: var(--charcoal); }
  .score-desc { font-size: 11.5px; color: var(--mid); margin-top: 3px; }
  .step { display: flex; gap: 14px; margin-bottom: 14px; align-items: flex-start; }
  .step-num { background: var(--red); color: #fff; font-weight: 800; font-size: 12px; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
  .step-body { font-size: 13px; color: var(--mid); line-height: 1.65; }
  .step-body strong { color: var(--charcoal); }
  code { background: #f0f0f0; border: 1px solid var(--border); border-radius: 3px; padding: 1px 6px; font-size: 12px; color: var(--charcoal); font-family: monospace; }

  footer { background: var(--charcoal); color: rgba(255,255,255,0.5); text-align: center; padding: 20px; font-size: 11px; letter-spacing: 0.04em; margin-top: 40px; }
  footer a { color: rgba(255,255,255,0.6); text-decoration: none; }
  footer a:hover { color: #fff; }

  @media(max-width: 700px) {
    header { padding: 0 16px; }
    .main { padding: 20px 16px 40px; }
    .tab-bar-inner { padding: 0 4px; }
    .tab-btn { padding: 12px 10px; font-size: 10px; }
    .xinner { padding: 12px 16px; }
    .guide-card { padding: 20px 18px; }
  }
</style>
</head>
<body>

<div class="top-bar">
  Northern Liberties Neighbors Association Â· 700 N 3rd Street, Philadelphia PA 19123 Â·
  <a href="https://www.nlna.org" target="_blank">nlna.org</a>
</div>

<header>
  <div class="header-inner">
    <div class="nlna-logo-block">
      <span class="nlna-org">NLNA</span>
      <span class="nlna-name">Northern<br><span>Liberties</span></span>
    </div>
    <div class="header-text">
      <div class="header-title">ğŸ€„ Mah Jongg Club</div>
      <div class="header-sub">Community Center Â· 1st &amp; 3rd Wednesdays</div>
    </div>
    <div class="session-chip">
      <span class="chip-label">Next Meeting</span>
      <span id="chip-date">â€”</span>
    </div>
  </div>
</header>

<div class="tab-bar">
  <div class="tab-bar-inner">
    <button class="tab-btn active" onclick="switchTab('leaderboard')">ğŸ† Leaderboard</button>
    <button class="tab-btn" onclick="switchTab('history')">Game History</button>
    <button class="tab-btn" onclick="switchTab('guide')">Scoring Guide</button>
    <button class="tab-btn" onclick="switchTab('howto')">How to Update</button>
  </div>
</div>

<div class="main">

  <!-- LEADERBOARD -->
  <div class="panel active" id="panel-leaderboard">
    <div class="sec-hdr">
      <div class="sec-title">Season Standings</div>
      <div class="sec-meta" id="lb-meta"></div>
      <button class="btn-refresh" id="refresh-btn" onclick="loadAll()">â†» Refresh</button>
    </div>
    <div id="lb-area">
      <div class="status-box"><div class="spinner"></div><p>Loading standings from Google Sheetsâ€¦</p></div>
    </div>
    <p class="hint" id="lb-hint" style="display:none">Click column headers to sort Â· Click a row to expand details</p>
  </div>

  <!-- HISTORY -->
  <div class="panel" id="panel-history">
    <div class="sec-hdr">
      <div class="sec-title">Game History</div>
      <div class="sec-meta" id="hist-meta"></div>
    </div>
    <div class="hist-card">
      <div class="hist-controls">
        <label>Filter by player:</label>
        <select id="hist-filter" onchange="renderHistory()">
          <option value="">All players</option>
        </select>
      </div>
      <ul class="hist-list" id="hist-list">
        <div class="no-data">Loadingâ€¦</div>
      </ul>
    </div>
  </div>

  <!-- SCORING GUIDE -->
  <div class="panel" id="panel-guide">
    <div class="sec-hdr"><div class="sec-title">Scoring Guide</div></div>
    <div class="guide-card">
      <h3>Hand Point Values (NMJL Rules)</h3>
      <div class="score-grid">
        <div class="score-box"><div class="score-pts">25â€“35</div><div class="score-desc">Standard / easier hands</div></div>
        <div class="score-box"><div class="score-pts">40â€“60</div><div class="score-desc">Mid-difficulty hands</div></div>
        <div class="score-box"><div class="score-pts">65â€“75</div><div class="score-desc">Difficult hands</div></div>
        <div class="score-box"><div class="score-pts">80â€“85</div><div class="score-desc">Hardest / rarest hands</div></div>
        <div class="score-box bonus"><div class="score-pts">+10</div><div class="score-desc">Self-picked (won from wall)</div></div>
        <div class="score-box bonus"><div class="score-pts">+20</div><div class="score-desc">Jokerless hand</div></div>
        <div class="score-box bonus"><div class="score-pts">+30</div><div class="score-desc">Self-picked AND Jokerless</div></div>
      </div>
      <h3>How Points Are Tracked</h3>
      <div class="callout callout-blue">
        <strong>Winner earns</strong> the hand's point value plus any bonuses â€” these accumulate over the season.<br>
        <strong>Other 3 players</strong> each receive a loss (tracked for win-rate, no point deduction).<br>
        <strong>Wall game:</strong> no points, no wins â€” all 4 players get a wall-game tally.<br>
        <strong>Absent members</strong> are not counted â€” only log the 4 who actually played.
      </div>
      <h3>Schedule</h3>
      <div class="callout callout-blue">
        Meets on the <strong>1st and 3rd Wednesday of each month</strong> at the NLNA Community Center,
        700 N 3rd Street, Philadelphia PA 19123. With 12 members, up to 3 tables of 4 can play each session.
      </div>
    </div>
  </div>

  <!-- HOW TO UPDATE -->
  <div class="panel" id="panel-howto">
    <div class="sec-hdr"><div class="sec-title">How to Update the Leaderboard</div></div>
    <div class="guide-card">

      <h3>Overview</h3>
      <p>This page reads live from a Google Sheet. To update standings, just edit the Sheet â€” everyone sees the new data the next time they load or refresh the page. No coding required.</p>

      <h3>One-Time Setup: Publish the Sheet</h3>
      <p>The Sheet must be published so the website can read it. You only do this once:</p>
      <div class="step"><div class="step-num">1</div><div class="step-body">Open your Google Sheet. Go to <strong>File â†’ Share â†’ Publish to web</strong>.</div></div>
      <div class="step"><div class="step-num">2</div><div class="step-body">In the first dropdown select <strong>Players</strong>, in the second select <strong>Comma-separated values (.csv)</strong>. Click <strong>Publish</strong>. Click OK.</div></div>
      <div class="step"><div class="step-num">3</div><div class="step-body">Repeat step 2 for the <strong>Games</strong> tab.</div></div>
      <div class="callout callout-red">
        âš ï¸ The Sheet itself stays private â€” only you can edit it. Publishing to web only allows the site to <em>read</em> the data.
      </div>

      <h3>Tab 1 â€” Players</h3>
      <p>Create a tab named exactly <code>Players</code>. Row 1 is the header. One member per row:</p>
      <div class="callout callout-blue callout-mono">
        <strong>id &nbsp; | name</strong><br>
        1 &nbsp;&nbsp; | Rachel<br>
        2 &nbsp;&nbsp; | Louise<br>
        3 &nbsp;&nbsp; | Jeff<br>
        4 &nbsp;&nbsp; | Donna<br>
        5 &nbsp;&nbsp; | Ellie<br>
        6 &nbsp;&nbsp; | Monica<br>
        7 &nbsp;&nbsp; | Sasha<br>
        8 &nbsp;&nbsp; | Sung<br>
        9 &nbsp;&nbsp; | Lystra<br>
        10 | Jill<br>
        11 | Player 1<br>
        12 | Player 2
      </div>
      <p>To rename a member, just change the name in this tab. Their stats will update automatically.</p>

      <h3>Tab 2 â€” Games</h3>
      <p>Create a tab named exactly <code>Games</code>. Row 1 is the header. Add one row per game after each session:</p>
      <div class="callout callout-blue callout-mono">
        <strong>date &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| type | winner_id | points | player1_id | player2_id | player3_id | player4_id | notes</strong><br>
        2026-03-05 | win &nbsp;| 1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 50 &nbsp;&nbsp; | 1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 3 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 7 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 9 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| Concealed hand<br>
        2026-03-05 | wall | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 4 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 6 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 10 &nbsp;&nbsp;&nbsp;&nbsp; |
      </div>
      <p style="margin-top:10px;"><strong>type</strong> is <code>win</code> or <code>wall</code>. For wall games, leave <code>winner_id</code> and <code>points</code> blank. Player id numbers come from the Players tab. The winner must be one of the four player columns. The <code>notes</code> column is optional.</p>

      <h3>Logging a Game â€” Step by Step</h3>
      <div class="step"><div class="step-num">1</div><div class="step-body">After a session, open your Google Sheet and click the <strong>Games</strong> tab.</div></div>
      <div class="step"><div class="step-num">2</div><div class="step-body">Add a new row at the bottom for each game played. Fill in the date in <code>YYYY-MM-DD</code> format, the result type, winner's id, point value, and all four player ids.</div></div>
      <div class="step"><div class="step-num">3</div><div class="step-body">Google Sheets auto-saves. Tell your club members to click <strong>â†» Refresh</strong> on the leaderboard page to see the new standings.</div></div>
      <div class="callout callout-blue">
        ğŸ’¡ <strong>Tip:</strong> Keep a printed copy of the id-to-name list handy at games so you can quickly look up numbers when logging.
      </div>
    </div>
  </div>

</div>

<footer>
  NLNA Community Center Mah Jongg Club &nbsp;Â·&nbsp;
  <a href="https://www.nlna.org/community-center" target="_blank">nlna.org/community-center</a>
  &nbsp;Â·&nbsp; 700 N 3rd Street, Philadelphia PA 19123
</footer>

<script>
// â”€â”€â”€ CONFIG â€” your Google Sheet ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHEET_ID    = '1Ymzcy_cDXDAl2Tz9Q1zfT_6DsoF_32g1RB8flTidqtQ';
const PLAYERS_TAB = 'Players';
const GAMES_TAB   = 'Games';

function csvUrl(tab) {
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;
}

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let players = [];
let games   = [];
let sort    = { key: 'points', dir: -1 };

// â”€â”€â”€ CSV PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCSV(text) {
  const lines = text.trim().split('\n');
  return lines.map(line => {
    const cols = []; let cur = '', inQ = false;
    for (const c of line) {
      if (c === '"') { inQ = !inQ; continue; }
      if (c === ',' && !inQ) { cols.push(cur.trim()); cur = ''; continue; }
      cur += c;
    }
    cols.push(cur.trim());
    return cols;
  });
}

function toObjects(rows) {
  if (rows.length < 2) return [];
  const headers = rows[0].map(h => h.toLowerCase().replace(/\s+/g, '_'));
  return rows.slice(1)
    .filter(r => r.some(c => c !== ''))
    .map(r => Object.fromEntries(headers.map((h, i) => [h, r[i] || ''])));
}

// â”€â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAll() {
  const btn = document.getElementById('refresh-btn');
  btn.textContent = 'â†» Loadingâ€¦'; btn.style.pointerEvents = 'none';
  document.getElementById('lb-area').innerHTML =
    '<div class="status-box"><div class="spinner"></div><p>Loading from Google Sheetsâ€¦</p></div>';
  document.getElementById('lb-hint').style.display = 'none';

  try {
    const [pText, gText] = await Promise.all([
      fetch(csvUrl(PLAYERS_TAB), { cache: 'no-store' }).then(r => { if (!r.ok) throw new Error(`HTTP ${r.status} loading Players tab`); return r.text(); }),
      fetch(csvUrl(GAMES_TAB),   { cache: 'no-store' }).then(r => { if (!r.ok) throw new Error(`HTTP ${r.status} loading Games tab`);   return r.text(); }),
    ]);

    // Build player map
    const pMap = {};
    toObjects(parseCSV(pText)).forEach(r => {
      const id = parseInt(r.id);
      if (!isNaN(id) && r.name)
        pMap[id] = { id, name: r.name, points: 0, wins: 0, losses: 0, walls: 0, games: 0, highHand: 0 };
    });

    // Process games
    games = [];
    toObjects(parseCSV(gText)).forEach(r => {
      const type = (r.type || '').toLowerCase().trim();
      const date = (r.date || '').trim();
      if (!date || !type) return;

      const pids = [r.player1_id, r.player2_id, r.player3_id, r.player4_id]
        .map(v => parseInt(v)).filter(v => !isNaN(v) && pMap[v]);

      if (type === 'win') {
        const wid = parseInt(r.winner_id);
        const pts = parseInt(r.points) || 0;
        if (isNaN(wid) || !pMap[wid]) return;
        pMap[wid].points += pts;
        pMap[wid].wins++;
        pMap[wid].games++;
        if (pts > pMap[wid].highHand) pMap[wid].highHand = pts;
        pids.forEach(pid => { if (pid !== wid) { pMap[pid].losses++; pMap[pid].games++; } });
        games.push({ date, type: 'win', winnerId: wid, points: pts, playerIds: pids, notes: r.notes || '' });

      } else if (type === 'wall') {
        pids.forEach(pid => { pMap[pid].walls++; pMap[pid].games++; });
        games.push({ date, type: 'wall', playerIds: pids, notes: r.notes || '' });
      }
    });

    players = Object.values(pMap);

    const now = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    document.getElementById('lb-meta').textContent =
      `${games.length} game${games.length !== 1 ? 's' : ''} Â· refreshed ${now}`;

    renderLB();
    populateHistFilter();
    renderHistory();
    document.getElementById('lb-hint').style.display = '';

  } catch (err) {
    document.getElementById('lb-area').innerHTML = `
      <div class="status-box error">
        <strong>Could not load data from Google Sheets</strong><br><br>
        ${err.message}<br><br>
        Make sure:<br>
        â€¢ Both the <em>Players</em> and <em>Games</em> tabs exist with the correct column headers<br>
        â€¢ The Sheet is published to the web (File â†’ Share â†’ Publish to web) as CSV for each tab<br>
        â€¢ The Sheet ID in the HTML file matches your sheet<br><br>
        See the <strong>How to Update</strong> tab for full setup instructions.
      </div>`;
  }

  btn.textContent = 'â†» Refresh'; btn.style.pointerEvents = '';
}

// â”€â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sortBy(key) {
  sort.key === key ? sort.dir *= -1 : (sort.key = key, sort.dir = key === 'name' ? 1 : -1);
  renderLB();
}

function renderLB() {
  if (!players.length) return;
  const byPts  = [...players].sort((a, b) => b.points - a.points);
  const sorted = [...players].sort((a, b) => {
    const va = a[sort.key], vb = b[sort.key];
    return typeof va === 'string' ? sort.dir * va.localeCompare(vb)
      : sort.dir === -1 ? vb - va : va - vb;
  });

  document.getElementById('lb-area').innerHTML = `
    <div class="lb-wrap"><table id="lb-table">
      <thead><tr>
        <th style="width:40px">#</th>
        <th onclick="sortBy('name')">Player <span class="arr">â†•</span></th>
        <th onclick="sortBy('points')">Points <span class="arr">â†•</span></th>
        <th onclick="sortBy('wins')">Wins <span class="arr">â†•</span></th>
        <th onclick="sortBy('losses')">Losses <span class="arr">â†•</span></th>
        <th onclick="sortBy('walls')">Walls <span class="arr">â†•</span></th>
        <th onclick="sortBy('games')">Games <span class="arr">â†•</span></th>
        <th>Win Rate</th>
        <th>Avg/Win</th>
      </tr></thead>
      <tbody id="lb-body"></tbody>
    </table></div>`;

  // Apply sort indicator
  const keyIdx = { name:1, points:2, wins:3, losses:4, walls:5, games:6 };
  const ths = document.querySelectorAll('#lb-table thead th');
  if (keyIdx[sort.key] !== undefined) {
    ths[keyIdx[sort.key]].classList.add('sorted');
    const a = ths[keyIdx[sort.key]].querySelector('.arr');
    if (a) a.textContent = sort.dir === 1 ? 'â†‘' : 'â†“';
  }

  const tbody = document.getElementById('lb-body');
  sorted.forEach(p => {
    const rank = byPts.findIndex(x => x.id === p.id) + 1;
    const rc   = rank <= 3 ? `r${rank}` : 'rn';
    const wr   = p.games > 0 ? (p.wins / p.games * 100) : 0;
    const avg  = p.wins  > 0 ? Math.round(p.points / p.wins) : 'â€”';
    const lastW = [...games].reverse().find(g => g.type === 'win' && g.winnerId === p.id);

    const tr = document.createElement('tr');
    tr.style.cursor = 'pointer';
    tr.innerHTML = `
      <td><span class="rank-num ${rc}">${rank}</span></td>
      <td><span class="pname">${p.name}</span></td>
      <td><span class="pts-big">${p.points}</span></td>
      <td><span class="pill pill-w">${p.wins}W</span></td>
      <td><span class="pill pill-l">${p.losses}L</span></td>
      <td><span class="pill pill-wg">${p.walls}</span></td>
      <td>${p.games}</td>
      <td><div class="rate-wrap"><div class="rate-bar"><div class="rate-fill" style="width:${wr}%"></div></div><span class="rate-pct">${wr.toFixed(0)}%</span></div></td>
      <td>${avg}</td>`;
    tr.addEventListener('click', () => toggleExpand(p.id));
    tbody.appendChild(tr);

    const xtr = document.createElement('tr');
    xtr.className = 'xrow'; xtr.id = `xrow-${p.id}`;
    xtr.innerHTML = `<td colspan="9"><div class="xinner">
      <div class="xstat"><span class="xstat-label">Total Points</span><span class="xstat-val">${p.points}</span></div>
      <div class="xstat"><span class="xstat-label">Best Hand</span><span class="xstat-val">${p.highHand || 'â€”'} pts</span></div>
      <div class="xstat"><span class="xstat-label">Games Played</span><span class="xstat-val">${p.games}</span></div>
      <div class="xstat"><span class="xstat-label">Last Win</span><span class="xstat-val">${lastW ? fmtDate(lastW.date) : 'â€”'}</span></div>
      <div class="xstat"><span class="xstat-label">Wall Game %</span><span class="xstat-val">${p.games > 0 ? (p.walls/p.games*100).toFixed(0) : 0}%</span></div>
    </div></td>`;
    tbody.appendChild(xtr);
  });
}

function toggleExpand(pid) {
  const row = document.getElementById(`xrow-${pid}`);
  if (!row) return;
  const open = row.style.display === 'table-row';
  document.querySelectorAll('.xrow').forEach(r => r.style.display = 'none');
  if (!open) row.style.display = 'table-row';
}

// â”€â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(d) {
  try { return new Date(d + 'T12:00:00').toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' }); }
  catch { return d; }
}
function pName(id) { return players.find(p => p.id === id)?.name || `#${id}`; }

function populateHistFilter() {
  const sel = document.getElementById('hist-filter');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All players</option>' +
    players.map(p => `<option value="${p.id}"${cur == p.id ? ' selected' : ''}>${p.name}</option>`).join('');
}

function renderHistory() {
  const filter   = document.getElementById('hist-filter').value;
  let filtered   = [...games].reverse();
  if (filter) filtered = filtered.filter(g => g.playerIds.includes(parseInt(filter)));
  document.getElementById('hist-meta').textContent = `${filtered.length} result${filtered.length !== 1 ? 's' : ''}`;

  const list = document.getElementById('hist-list');
  if (!filtered.length) {
    list.innerHTML = '<div class="no-data">No games found. Data is loaded from the Google Sheet.</div>'; return;
  }
  list.innerHTML = filtered.map(g => {
    if (g.type === 'wall') return `
      <li class="hist-item">
        <span class="hist-date">${fmtDate(g.date)}</span>
        <span class="hist-wall">ğŸ§± Wall Game</span>
        <span class="hist-others">${g.playerIds.map(pName).join(', ')}</span>
        ${g.notes ? `<span class="hist-note">"${g.notes}"</span>` : ''}
      </li>`;
    const others = g.playerIds.filter(id => id !== g.winnerId).map(pName).join(', ');
    return `
      <li class="hist-item">
        <span class="hist-date">${fmtDate(g.date)}</span>
        <span class="hist-winner">${pName(g.winnerId)}</span>
        <span class="hist-pts">${g.points} pts</span>
        <span class="hist-others">vs ${others}</span>
        ${g.notes ? `<span class="hist-note">"${g.notes}"</span>` : ''}
      </li>`;
  }).join('');
}

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TABS = ['leaderboard', 'history', 'guide', 'howto'];
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', TABS[i] === name));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
}

// â”€â”€â”€ NEXT SESSION CHIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initHeader() {
  const now = new Date(), sessions = [];
  for (let m = 0; m < 4; m++) {
    const base = new Date(now.getFullYear(), now.getMonth() + m, 1);
    [1, 3].forEach(week => {
      const firstWed = 1 + ((3 - base.getDay() + 7) % 7);
      const nth = firstWed + (week - 1) * 7;
      if (nth <= new Date(base.getFullYear(), base.getMonth() + 1, 0).getDate()) {
        const d = new Date(base.getFullYear(), base.getMonth(), nth);
        if (d > now) sessions.push(d);
      }
    });
  }
  sessions.sort((a, b) => a - b);
  if (sessions.length) {
    const next = sessions[0], days = Math.round((next - now) / 86400000);
    const label = days === 0 ? 'Today!' : days === 1 ? 'Tomorrow' : `in ${days} days`;
    document.getElementById('chip-date').innerHTML =
      `${next.toLocaleDateString('en-US',{month:'short',day:'numeric'})} <span style="font-weight:400;opacity:0.8;font-size:10px;">(${label})</span>`;
  }
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initHeader();
loadAll();
</script>
</body>
</html>
